name: Prod Deploy Blog Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - '.github/workflows/_shared_deploy_cloudrun.yml'
      - '.github/workflows/prod_deploy_cloudrun.yml'

jobs:
  discord_notification_before_job:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: sarisia/actions-status-discord@v1
        with:
          status: Success
          noprefix: true
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          color: 0xA3EEFF

  deploy_cloudrun:
    uses: ./.github/workflows/_shared_deploy_cloudrun.yml
    needs:
      - discord_notification_before_job
    with:
      env_name: production
      google_cloud_project_id: kotofurumiya-dotdev
      google_cloud_region: asia-northeast1
      google_cloud_workload_identity_provider: 'projects/583712481801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions'
      google_cloud_service_account: 'cloudrun-deploy@kotofurumiya-dotdev.iam.gserviceaccount.com'
      cloudrun_service_account: 'blog-service@kotofurumiya-dotdev.iam.gserviceaccount.com'
    secrets:
      CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
      CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_DELIVERY_ACCESS_TOKEN }}
    permissions:
      contents: read
      id-token: write

  discord_notification_after_job:
    if: always()
    needs:
      - terraform_apply
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: technote-space/workflow-conclusion-action@v1

      - uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          status: ${{ env.WORKFLOW_CONCLUSION }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}